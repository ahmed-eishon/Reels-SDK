name: Publish Android SDK to GitHub Packages

on:
  push:
    tags:
      - 'v*.*.*-android-maven'       # Disabled - use release-android.yml for GitHub Releases instead
      - 'v*.*.*-android-maven-debug' # Disabled - use release-android-debug.yml for GitHub Releases instead

jobs:
  publish-maven:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version and build type from tag
        id: get_version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}

          if [[ "$TAG" == *"-android-debug" ]]; then
            VERSION=${TAG%-android-debug}
            BUILD_TYPE="debug"
            echo "BUILD_TYPE=debug" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == *"-android" ]]; then
            VERSION=${TAG%-android}
            BUILD_TYPE="release"
            echo "BUILD_TYPE=release" >> $GITHUB_OUTPUT
          else
            echo "Invalid tag format: $TAG"
            exit 1
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION (build type: $BUILD_TYPE)"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            reels_flutter/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('reels_flutter/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            reels_android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Get Flutter dependencies
        working-directory: reels_flutter
        run: flutter pub get

      - name: Run Pigeon code generation
        working-directory: reels_flutter
        run: flutter pub run pigeon --input pigeons/messages.dart

      - name: Build Flutter AAR
        working-directory: reels_flutter
        run: |
          if [ "${{ steps.get_version.outputs.BUILD_TYPE }}" == "debug" ]; then
            echo "Building Flutter AAR in Debug mode..."
            flutter build aar --debug --no-release --no-profile
          else
            echo "Building Flutter AAR in Release mode..."
            flutter build aar --release --no-debug --no-profile
          fi
          echo "Flutter AAR built successfully"

      - name: List Flutter build outputs
        run: |
          echo "=== Flutter AAR outputs ==="
          find reels_flutter/build/host/outputs/repo -name "*.aar" -type f

      - name: Publish reels_android to GitHub Packages
        working-directory: reels_android
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo "Publishing reels_android to GitHub Packages..."
          if [ "${{ steps.get_version.outputs.BUILD_TYPE }}" == "debug" ]; then
            ../gradlew publishReleasePublicationToGitHubPackagesRepository --no-daemon --stacktrace
          else
            ../gradlew publishReleasePublicationToGitHubPackagesRepository --no-daemon --stacktrace
          fi
          echo "Published successfully!"

      - name: Create package summary
        run: |
          echo "âœ… Maven package published successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“¦ Package Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Group ID**: com.rakuten.room" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact ID**: reels-sdk" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type**: ${{ steps.get_version.outputs.BUILD_TYPE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.get_version.outputs.TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸš€ How to Use" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 1. Add GitHub Packages repository in settings.gradle:" >> $GITHUB_STEP_SUMMARY
          echo '```gradle' >> $GITHUB_STEP_SUMMARY
          echo 'dependencyResolutionManagement {' >> $GITHUB_STEP_SUMMARY
          echo '    repositories {' >> $GITHUB_STEP_SUMMARY
          echo '        google()' >> $GITHUB_STEP_SUMMARY
          echo '        mavenCentral()' >> $GITHUB_STEP_SUMMARY
          echo '        maven {' >> $GITHUB_STEP_SUMMARY
          echo '            url = uri("https://maven.pkg.github.com/ahmed-eishon/Reels-SDK")' >> $GITHUB_STEP_SUMMARY
          echo '            credentials {' >> $GITHUB_STEP_SUMMARY
          echo '                username = project.findProperty("gpr.user") ?: System.getenv("GITHUB_ACTOR")' >> $GITHUB_STEP_SUMMARY
          echo '                password = project.findProperty("gpr.key") ?: System.getenv("GITHUB_TOKEN")' >> $GITHUB_STEP_SUMMARY
          echo '            }' >> $GITHUB_STEP_SUMMARY
          echo '        }' >> $GITHUB_STEP_SUMMARY
          echo '    }' >> $GITHUB_STEP_SUMMARY
          echo '}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 2. Add dependency in app/build.gradle:" >> $GITHUB_STEP_SUMMARY
          echo '```gradle' >> $GITHUB_STEP_SUMMARY
          echo "dependencies {" >> $GITHUB_STEP_SUMMARY
          echo "    implementation 'com.rakuten.room:reels-sdk:${{ steps.get_version.outputs.VERSION }}'" >> $GITHUB_STEP_SUMMARY
          echo "}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 3. Configure GitHub authentication:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Create \`~/.gradle/gradle.properties\` with:" >> $GITHUB_STEP_SUMMARY
          echo '```properties' >> $GITHUB_STEP_SUMMARY
          echo 'gpr.user=YOUR_GITHUB_USERNAME' >> $GITHUB_STEP_SUMMARY
          echo 'gpr.key=YOUR_GITHUB_PERSONAL_ACCESS_TOKEN' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“š [Full Documentation](https://github.com/ahmed-eishon/Reels-SDK/blob/master/docs/02-Integration/02-Android-Integration-Guide.md)" >> $GITHUB_STEP_SUMMARY

      - name: Publish Summary
        run: |
          echo "âœ… Maven package published to GitHub Packages!"
          echo "ğŸ“¦ Package: com.rakuten.room:reels-sdk:${{ steps.get_version.outputs.VERSION }}"
          echo "ğŸ·ï¸ Tag: ${{ github.ref_name }}"
          echo "ğŸ“‹ Version: ${{ steps.get_version.outputs.VERSION }}"
          echo "ğŸ”¨ Build Type: ${{ steps.get_version.outputs.BUILD_TYPE }}"
