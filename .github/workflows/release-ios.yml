name: Release ReelsSDK iOS

on:
  push:
    tags:
      - 'v*.*.*-ios'  # Trigger on iOS version tags (e.g., v1.0.0-ios)

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build-and-release-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          # Extract version from tag (v1.0.0-ios -> 1.0.0)
          VERSION="${GITHUB_REF#refs/tags/v}"
          VERSION="${VERSION%-ios}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify VERSION file matches tag
        run: |
          FILE_VERSION=$(cat VERSION)
          TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "VERSION file: $FILE_VERSION"
          echo "Git tag version: $TAG_VERSION"
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: VERSION file ($FILE_VERSION) does not match git tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            reels_flutter/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('reels_flutter/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install dependencies
        working-directory: reels_flutter
        run: flutter pub get

      - name: Regenerate Pigeon code
        working-directory: reels_flutter
        run: |
          flutter pub run pigeon \
            --input pigeons/messages.dart \
            --dart_out lib/core/pigeon_generated.dart \
            --swift_out ../reels_ios/Sources/ReelsIOS/PigeonGenerated.swift \
            --kotlin_out ../reels_android/src/main/java/com/rakuten/room/reels_android/PigeonGenerated.kt \
            --kotlin_package com.rakuten.room.reels_android

      - name: Build Debug frameworks
        working-directory: reels_flutter
        run: |
          echo "Building Debug frameworks..."
          flutter clean
          flutter build ios-framework --debug --output=.ios/Flutter/Debug

      - name: Build Release frameworks
        working-directory: reels_flutter
        run: |
          echo "Building Release frameworks..."
          flutter build ios-framework --release --output=.ios/Flutter/Release

      - name: Package Debug frameworks
        run: |
          ./scripts/sdk/ios/package-frameworks.sh Debug
          ls -lh ReelsSDK-Frameworks-Debug-${{ steps.get_version.outputs.VERSION }}.zip

      - name: Package Release frameworks
        run: |
          ./scripts/sdk/ios/package-frameworks.sh Release
          ls -lh ReelsSDK-Frameworks-Release-${{ steps.get_version.outputs.VERSION }}.zip

      - name: Generate framework manifest
        run: |
          echo "ReelsSDK iOS Framework Release v${{ steps.get_version.outputs.VERSION }}" > RELEASE_MANIFEST.txt
          echo "Platform: iOS" >> RELEASE_MANIFEST.txt
          echo "Generated: $(date)" >> RELEASE_MANIFEST.txt
          echo "" >> RELEASE_MANIFEST.txt
          echo "=== Debug Frameworks ===" >> RELEASE_MANIFEST.txt
          cat FRAMEWORK_MANIFEST_Debug.txt | grep -A 100 "Frameworks" >> RELEASE_MANIFEST.txt
          echo "" >> RELEASE_MANIFEST.txt
          echo "=== Release Frameworks ===" >> RELEASE_MANIFEST.txt
          cat FRAMEWORK_MANIFEST_Release.txt | grep -A 100 "Frameworks" >> RELEASE_MANIFEST.txt

      - name: Calculate checksums
        run: |
          shasum -a 256 ReelsSDK-Frameworks-Debug-${{ steps.get_version.outputs.VERSION }}.zip > CHECKSUMS.txt
          shasum -a 256 ReelsSDK-Frameworks-Release-${{ steps.get_version.outputs.VERSION }}.zip >> CHECKSUMS.txt
          cat CHECKSUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ReelsSDK iOS v${{ steps.get_version.outputs.VERSION }}
          body_path: RELEASE_MANIFEST.txt
          draft: false
          prerelease: false
          files: |
            ReelsSDK-Frameworks-Debug-${{ steps.get_version.outputs.VERSION }}.zip
            ReelsSDK-Frameworks-Release-${{ steps.get_version.outputs.VERSION }}.zip
            CHECKSUMS.txt

      - name: Release summary
        run: |
          echo "iOS Release v${{ steps.get_version.outputs.VERSION }} created successfully!"
          echo ""
          echo "Platform: iOS"
          echo "Artifacts:"
          echo "  - ReelsSDK-Frameworks-Debug-${{ steps.get_version.outputs.VERSION }}.zip"
          echo "  - ReelsSDK-Frameworks-Release-${{ steps.get_version.outputs.VERSION }}.zip"
          echo ""
          echo "Users can now install via CocoaPods:"
          echo "  pod 'ReelsSDK', :git => 'https://github.com/ahmed-eishon/Reels-SDK.git', :tag => 'v${{ steps.get_version.outputs.VERSION }}-ios'"
