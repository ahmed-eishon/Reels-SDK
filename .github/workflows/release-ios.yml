name: Release ReelsSDK iOS

on:
  push:
    tags:
      - 'v*.*.*-ios'        # Trigger on iOS Release tags (e.g., v1.0.0-ios)
      - 'v*.*.*-ios-debug'  # Trigger on iOS Debug tags (e.g., v1.0.0-ios-debug)

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build-and-release-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version and build mode from tag
        id: get_version
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/v}"

          # Detect build mode and extract version
          if [[ "$TAG_NAME" == *"-ios-debug" ]]; then
            BUILD_MODE="Debug"
            VERSION="${TAG_NAME%-ios-debug}"
          elif [[ "$TAG_NAME" == *"-ios" ]]; then
            BUILD_MODE="Release"
            VERSION="${TAG_NAME%-ios}"
          else
            echo "Error: Invalid tag format"
            exit 1
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_MODE=$BUILD_MODE" >> $GITHUB_OUTPUT
          echo "Detected: VERSION=$VERSION, BUILD_MODE=$BUILD_MODE"

      - name: Verify VERSION file matches tag
        run: |
          FILE_VERSION=$(cat VERSION)
          TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "VERSION file: $FILE_VERSION"
          echo "Git tag version: $TAG_VERSION"
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: VERSION file ($FILE_VERSION) does not match git tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            reels_flutter/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('reels_flutter/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install dependencies
        working-directory: reels_flutter
        run: flutter pub get

      - name: Regenerate Pigeon code
        working-directory: reels_flutter
        run: |
          flutter pub run pigeon \
            --input pigeons/messages.dart \
            --dart_out lib/core/pigeon_generated.dart \
            --swift_out ../reels_ios/Sources/ReelsIOS/PigeonGenerated.swift \
            --kotlin_out ../reels_android/src/main/java/com/rakuten/room/reels_android/PigeonGenerated.kt \
            --kotlin_package com.rakuten.room.reels_android

      - name: Build frameworks
        working-directory: reels_flutter
        run: |
          BUILD_MODE="${{ steps.get_version.outputs.BUILD_MODE }}"
          echo "Building $BUILD_MODE frameworks..."
          flutter clean

          if [ "$BUILD_MODE" = "Debug" ]; then
            flutter build ios-framework --debug --output=.ios/Flutter/Debug
          else
            flutter build ios-framework --release --output=.ios/Flutter/Release
          fi

      - name: Package frameworks
        run: |
          BUILD_MODE="${{ steps.get_version.outputs.BUILD_MODE }}"
          ./scripts/sdk/ios/package-frameworks.sh $BUILD_MODE
          ls -lh ReelsSDK-Frameworks-$BUILD_MODE-${{ steps.get_version.outputs.VERSION }}.zip

      - name: Generate framework manifest
        run: |
          BUILD_MODE="${{ steps.get_version.outputs.BUILD_MODE }}"
          echo "ReelsSDK iOS Framework $BUILD_MODE v${{ steps.get_version.outputs.VERSION }}" > RELEASE_MANIFEST.txt
          echo "Platform: iOS" >> RELEASE_MANIFEST.txt
          echo "Build Mode: $BUILD_MODE" >> RELEASE_MANIFEST.txt
          echo "Generated: $(date)" >> RELEASE_MANIFEST.txt
          echo "" >> RELEASE_MANIFEST.txt
          echo "=== $BUILD_MODE Frameworks ===" >> RELEASE_MANIFEST.txt
          cat FRAMEWORK_MANIFEST_$BUILD_MODE.txt | grep -A 100 "Frameworks" >> RELEASE_MANIFEST.txt

      - name: Calculate checksums
        run: |
          BUILD_MODE="${{ steps.get_version.outputs.BUILD_MODE }}"
          shasum -a 256 ReelsSDK-Frameworks-$BUILD_MODE-${{ steps.get_version.outputs.VERSION }}.zip > CHECKSUMS.txt
          cat CHECKSUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ReelsSDK iOS ${{ steps.get_version.outputs.BUILD_MODE }} v${{ steps.get_version.outputs.VERSION }}
          body_path: RELEASE_MANIFEST.txt
          draft: false
          prerelease: false
          files: |
            ReelsSDK-Frameworks-${{ steps.get_version.outputs.BUILD_MODE }}-${{ steps.get_version.outputs.VERSION }}.zip
            CHECKSUMS.txt

      - name: Release summary
        run: |
          BUILD_MODE="${{ steps.get_version.outputs.BUILD_MODE }}"
          TAG_SUFFIX=$([ "$BUILD_MODE" = "Debug" ] && echo "-ios-debug" || echo "-ios")

          echo "$BUILD_MODE Release v${{ steps.get_version.outputs.VERSION }} created successfully!"
          echo ""
          echo "Platform: iOS"
          echo "Build Mode: $BUILD_MODE"
          echo "Artifacts:"
          echo "  - ReelsSDK-Frameworks-$BUILD_MODE-${{ steps.get_version.outputs.VERSION }}.zip"
          echo ""
          echo "Users can now install via CocoaPods:"
          echo "  pod 'ReelsSDK', :git => 'https://github.com/ahmed-eishon/Reels-SDK.git', :tag => 'v${{ steps.get_version.outputs.VERSION }}$TAG_SUFFIX'"
