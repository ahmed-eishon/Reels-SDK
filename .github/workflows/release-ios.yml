name: Release ReelsSDK iOS

on:
  push:
    tags:
      - 'v*.*.*-ios'  # Trigger on iOS release tags (e.g., v0.1.2-ios)

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build-and-release-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/v}"
          VERSION="${TAG_NAME%-ios}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected VERSION: $VERSION (from tag: v$TAG_NAME)"

      - name: Verify VERSION file matches tag
        run: |
          FILE_VERSION=$(cat VERSION)
          TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "VERSION file: $FILE_VERSION"
          echo "Git tag version: $TAG_VERSION"
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: VERSION file ($FILE_VERSION) does not match git tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            reels_flutter/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('reels_flutter/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install dependencies
        working-directory: reels_flutter
        run: flutter pub get

      - name: Regenerate Pigeon code
        working-directory: reels_flutter
        run: |
          flutter pub run pigeon \
            --input pigeons/messages.dart \
            --dart_out lib/core/pigeon_generated.dart \
            --swift_out ../reels_ios/Sources/ReelsIOS/PigeonGenerated.swift \
            --kotlin_out ../reels_android/src/main/java/com/rakuten/room/reels_android/PigeonGenerated.kt \
            --kotlin_package com.rakuten.room.reels_android

      - name: Build Debug frameworks
        working-directory: reels_flutter
        run: |
          echo "Building Debug frameworks..."
          flutter clean
          flutter build ios-framework --debug --output=../Frameworks/Debug

      - name: Build Release frameworks
        working-directory: reels_flutter
        run: |
          echo "Building Release frameworks..."
          flutter clean
          flutter build ios-framework --release --output=../Frameworks/Release

      - name: Package frameworks
        run: |
          ./scripts/sdk/ios/package-all-frameworks.sh ${{ steps.get_version.outputs.VERSION }}
          echo ""
          echo "Packages created:"
          ls -lh ReelsSDK-Frameworks-*.zip

      - name: Generate Debug release manifest
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "ReelsSDK iOS Debug Frameworks v$VERSION" > DEBUG_MANIFEST.txt
          echo "Platform: iOS (Debug)" >> DEBUG_MANIFEST.txt
          echo "Generated: $(date)" >> DEBUG_MANIFEST.txt
          echo "" >> DEBUG_MANIFEST.txt
          echo "=== Installation ===" >> DEBUG_MANIFEST.txt
          echo "pod 'ReelsSDK', :git => 'https://github.com/ahmed-eishon/Reels-SDK.git', :tag => 'v$VERSION-ios-debug'" >> DEBUG_MANIFEST.txt
          echo "" >> DEBUG_MANIFEST.txt
          echo "Use this tag for development/testing with Debug frameworks." >> DEBUG_MANIFEST.txt

      - name: Generate Release manifest
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "ReelsSDK iOS Release Frameworks v$VERSION" > RELEASE_MANIFEST.txt
          echo "Platform: iOS (Release)" >> RELEASE_MANIFEST.txt
          echo "Generated: $(date)" >> RELEASE_MANIFEST.txt
          echo "" >> RELEASE_MANIFEST.txt
          echo "=== Installation ===" >> RELEASE_MANIFEST.txt
          echo "pod 'ReelsSDK', :git => 'https://github.com/ahmed-eishon/Reels-SDK.git', :tag => 'v$VERSION-ios'" >> RELEASE_MANIFEST.txt
          echo "" >> RELEASE_MANIFEST.txt
          echo "Use this tag for production builds with optimized Release frameworks." >> RELEASE_MANIFEST.txt

      - name: Calculate checksums
        run: |
          shasum -a 256 ReelsSDK-Frameworks-*.zip > CHECKSUMS.txt
          cat CHECKSUMS.txt

      - name: Create Debug GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}-ios-debug
          name: ReelsSDK iOS Debug v${{ steps.get_version.outputs.VERSION }}
          body_path: DEBUG_MANIFEST.txt
          draft: false
          prerelease: false
          files: |
            ReelsSDK-Frameworks-Debug-${{ steps.get_version.outputs.VERSION }}.zip
            CHECKSUMS.txt

      - name: Create Release GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}-ios
          name: ReelsSDK iOS Release v${{ steps.get_version.outputs.VERSION }}
          body_path: RELEASE_MANIFEST.txt
          draft: false
          prerelease: false
          files: |
            ReelsSDK-Frameworks-${{ steps.get_version.outputs.VERSION }}.zip
            CHECKSUMS.txt

      - name: Release summary
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "iOS Release v$VERSION created successfully!"
          echo ""
          echo "Platform: iOS"
          echo "Packages:"
          echo "  - ReelsSDK-Frameworks-$VERSION.zip (FULL)"
          echo "  - ReelsSDK-Frameworks-Debug-$VERSION.zip"
          echo "  - ReelsSDK-Frameworks-Release-$VERSION.zip"
          echo ""
          echo "Install via CocoaPods:"
          echo "  pod 'ReelsSDK', :git => 'https://github.com/ahmed-eishon/Reels-SDK.git', :tag => 'v$VERSION-ios'"
