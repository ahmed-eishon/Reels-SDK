name: Release ReelsSDK

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (e.g., v1.0.0)

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify VERSION file matches tag
        run: |
          FILE_VERSION=$(cat VERSION)
          TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "VERSION file: $FILE_VERSION"
          echo "Git tag: $TAG_VERSION"
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: VERSION file ($FILE_VERSION) does not match git tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Install dependencies
        working-directory: reels_flutter
        run: flutter pub get

      - name: Regenerate Pigeon code
        working-directory: reels_flutter
        run: |
          flutter pub run pigeon \
            --input pigeons/messages.dart \
            --dart_out lib/core/pigeon_generated.dart \
            --swift_out ../reels_ios/Sources/ReelsIOS/PigeonGenerated.swift \
            --kotlin_out ../reels_android/src/main/java/com/rakuten/room/reels_android/PigeonGenerated.kt \
            --kotlin_package com.rakuten.room.reels_android

      - name: Build Debug frameworks
        working-directory: reels_flutter
        run: |
          echo "Building Debug frameworks..."
          flutter clean
          flutter build ios-framework --debug --output=.ios/Flutter/Debug

      - name: Build Release frameworks
        working-directory: reels_flutter
        run: |
          echo "Building Release frameworks..."
          flutter build ios-framework --release --output=.ios/Flutter/Release

      - name: Package Debug frameworks
        run: |
          ./scripts/sdk/ios/package-frameworks.sh Debug
          ls -lh ReelsSDK-Frameworks-Debug-${{ steps.get_version.outputs.VERSION }}.zip

      - name: Package Release frameworks
        run: |
          ./scripts/sdk/ios/package-frameworks.sh Release
          ls -lh ReelsSDK-Frameworks-Release-${{ steps.get_version.outputs.VERSION }}.zip

      - name: Generate framework manifest
        run: |
          echo "ReelsSDK Framework Release v${{ steps.get_version.outputs.VERSION }}" > RELEASE_MANIFEST.txt
          echo "Generated: $(date)" >> RELEASE_MANIFEST.txt
          echo "" >> RELEASE_MANIFEST.txt
          echo "=== Debug Frameworks ===" >> RELEASE_MANIFEST.txt
          cat FRAMEWORK_MANIFEST_Debug.txt | grep -A 100 "Frameworks:" >> RELEASE_MANIFEST.txt
          echo "" >> RELEASE_MANIFEST.txt
          echo "=== Release Frameworks ===" >> RELEASE_MANIFEST.txt
          cat FRAMEWORK_MANIFEST_Release.txt | grep -A 100 "Frameworks:" >> RELEASE_MANIFEST.txt

      - name: Calculate checksums
        run: |
          shasum -a 256 ReelsSDK-Frameworks-Debug-${{ steps.get_version.outputs.VERSION }}.zip > CHECKSUMS.txt
          shasum -a 256 ReelsSDK-Frameworks-Release-${{ steps.get_version.outputs.VERSION }}.zip >> CHECKSUMS.txt
          cat CHECKSUMS.txt

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: ReelsSDK v${{ steps.get_version.outputs.VERSION }}
          body_path: RELEASE_MANIFEST.txt
          draft: false
          prerelease: false

      - name: Upload Debug frameworks
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./ReelsSDK-Frameworks-Debug-${{ steps.get_version.outputs.VERSION }}.zip
          asset_name: ReelsSDK-Frameworks-Debug-${{ steps.get_version.outputs.VERSION }}.zip
          asset_content_type: application/zip

      - name: Upload Release frameworks
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./ReelsSDK-Frameworks-Release-${{ steps.get_version.outputs.VERSION }}.zip
          asset_name: ReelsSDK-Frameworks-Release-${{ steps.get_version.outputs.VERSION }}.zip
          asset_content_type: application/zip

      - name: Upload checksums
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./CHECKSUMS.txt
          asset_name: CHECKSUMS.txt
          asset_content_type: text/plain

      - name: Release summary
        run: |
          echo "Release v${{ steps.get_version.outputs.VERSION }} created successfully!"
          echo ""
          echo "Artifacts:"
          echo "  - Debug frameworks: $(ls -lh ReelsSDK-Frameworks-Debug-*.zip | awk '{print $5}')"
          echo "  - Release frameworks: $(ls -lh ReelsSDK-Frameworks-Release-*.zip | awk '{print $5}')"
          echo ""
          echo "Users can now install via CocoaPods:"
          echo "  pod 'ReelsSDK', :git => 'https://github.com/rakuten/reels-sdk.git', :tag => 'v${{ steps.get_version.outputs.VERSION }}'"
